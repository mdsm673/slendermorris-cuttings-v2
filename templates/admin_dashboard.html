{% extends "base.html" %}

{% block title %}Admin Dashboard - Fabric Cutting Ordering System{% endblock %}

{% block content %}
<div class="container-fluid py-2">
    <!-- Top Row with Search, Title, and Buttons -->
    <div class="row mb-4">
        <div class="col-md-5">
            <!-- Search Box -->
            <div class="d-flex align-items-center">
                <input type="text" class="form-control me-2" 
                       name="search" id="search" 
                       placeholder="Search all fields (real-time)..." 
                       value="{{ search_term or '' }}">
                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('search').value=''; document.getElementById('search').dispatchEvent(new Event('input'));" title="Clear Search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="col-md-3 text-center">
            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-1" style="font-size: 0.9rem;"></i>Cutting Requests Dashboard</h5>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('archived_requests') }}" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size: 0.7rem;">
                <i class="fas fa-archive me-1" style="font-size: 0.6rem;"></i><small>View Archive</small>
            </a>
            <a href="{{ url_for('data_integrity_check') }}" class="btn btn-sm btn-outline-info py-0 px-2" style="font-size: 0.7rem;">
                <i class="fas fa-shield-alt me-1" style="font-size: 0.6rem;"></i><small>Data Integrity</small>
            </a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-sm btn-outline-danger py-0 px-2" style="font-size: 0.75rem;">
                <i class="fas fa-sign-out-alt me-1" style="font-size: 0.7rem;"></i>Logout
            </a>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="status" class="form-label">Filter by Status</label>
                    <select class="form-select" id="status" name="status" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="Outstanding" {% if status_filter == 'Outstanding' %}selected{% endif %}>Outstanding</option>
                        <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Dispatched" {% if status_filter == 'Dispatched' %}selected{% endif %}>Dispatched</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sort" class="form-label">Sort by</label>
                    <select class="form-select" id="sort" name="sort" onchange="this.form.submit()">
                        <option value="date_submitted" {% if sort_by == 'date_submitted' %}selected{% endif %}>Date Submitted</option>
                        <option value="customer_name" {% if sort_by == 'customer_name' %}selected{% endif %}>Customer Name</option>
                        <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="order" class="form-label">Order</label>
                    <select class="form-select" id="order" name="order" onchange="this.form.submit()">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('admin_dashboard') }}'">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </button>
                </div>
                {% if search_term %}
                <input type="hidden" name="search" value="{{ search_term }}">
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Requests Table -->
    <div class="card">
        <div class="card-body">
            {% if requests %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="width: 5%;">ID</th>
                            <th style="width: 10%;">Date</th>
                            <th style="width: 12%;">Company</th>
                            <th style="width: 15%;">Email</th>
                            <th style="width: 10%;">Reference</th>
                            <th style="width: 22%;">Fabrics</th>
                            <th style="width: 10%;">Status</th>
                            <th style="width: 8%;">Dispatched</th>
                            <th style="width: 8%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set prev_status = '' %}
                        {% for request in requests %}
                        {% if (prev_status == 'Outstanding' or prev_status == 'In Progress') and request.status == 'Dispatched' %}
                        <tr class="table-separator">
                            <td colspan="9" class="text-center bg-light py-1">
                                <small class="text-muted">── Dispatched Orders ──</small>
                            </td>
                        </tr>
                        {% elif prev_status == 'Outstanding' and request.status == 'In Progress' %}
                        <tr class="table-separator">
                            <td colspan="9" class="text-center bg-light py-1">
                                <small class="text-muted">── In Progress Orders ──</small>
                            </td>
                        </tr>
                        {% endif %}
                        <tr data-request-id="{{ request.id }}" {% if request.status == 'Dispatched' %}class="dispatched-row"{% endif %}>
                            <td>#{{ request.id }}</td>
                            <td>{{ request.date_submitted.strftime('%m/%d') }}</td>
                            <td style="word-break: break-word;">
                                {{ request.company_name or request.customer_name or '-' }}
                            </td>
                            <td style="word-break: break-word;">{{ request.email }}</td>
                            <td style="word-break: break-word;">{{ request.reference or '-' }}</td>
                            <td style="max-width: none !important;">
                                {% if request.parsed_fabric_cuttings and request.parsed_fabric_cuttings|length > 0 %}
                                    <div style="display: flex; flex-direction: column; gap: 2px; width: 100%;">
                                        {% for cutting in request.parsed_fabric_cuttings %}
                                            {% if cutting and cutting.strip() %}
                                                <span class="badge bg-secondary" style="font-size: 0.8rem; padding: 0.2rem 0.4rem; width: fit-content;">{{ cutting.strip() }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if request.status == 'Outstanding' %}bg-warning text-dark
                                    {% elif request.status == 'In Progress' %}bg-info
                                    {% elif request.status == 'Dispatched' %}bg-success
                                    {% endif %}" style="font-size: 0.7rem;">
                                    {{ request.status }}
                                </span>
                            </td>
                            <td>
                                <span id="dispatch-date-{{ request.id }}" style="font-size: 0.8rem;">
                                    {{ request.date_dispatched.strftime('%m/%d') if request.date_dispatched else '-' }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-1 justify-content-start">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" style="padding: 0.2rem 0.4rem;" data-bs-toggle="dropdown" aria-expanded="false" title="Change Status">
                                            <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-sm">
                                            <li><a class="dropdown-item small" href="#" onclick="updateStatus({{ request.id }}, 'Outstanding')">Outstanding</a></li>
                                            <li><a class="dropdown-item small" href="#" onclick="updateStatus({{ request.id }}, 'In Progress')">In Progress</a></li>
                                            <li><a class="dropdown-item small" href="#" onclick="updateStatus({{ request.id }}, 'Dispatched')">Dispatched</a></li>
                                        </ul>
                                    </div>
                                    {% if request.parsed_fabric_cuttings and request.parsed_fabric_cuttings|length > 0 %}
                                    <button type="button" class="btn btn-sm" style="background-color: #ffd700; color: #333; border: 1px solid #ddd; padding: 0.2rem 0.4rem;" 
                                            onclick="openILIVModal({{ request.id }})" title="Email ILIV">
                                        <i class="fas fa-envelope" style="font-size: 0.75rem;"></i>
                                    </button>
                                    {% endif %}
                                    <a href="{{ url_for('request_details', request_id=request.id) }}" class="btn btn-sm btn-outline-primary" style="padding: 0.2rem 0.4rem;" title="View">
                                        <i class="fas fa-eye" style="font-size: 0.75rem;"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% set prev_status = request.status %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                {% if search_term %}
                <h5 class="text-muted">No results found for "{{ search_term }}"</h5>
                <p class="text-muted">Try adjusting your search terms or <a href="{{ url_for('admin_dashboard') }}">clear the search</a>.</p>
                {% elif status_filter %}
                <h5 class="text-muted">No requests found</h5>
                <p class="text-muted">No requests found with the selected filters.</p>
                {% else %}
                <h5 class="text-muted">No requests found</h5>
                <p class="text-muted">No cutting requests have been submitted yet.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ILIV Email Modal -->
<div class="modal fade" id="ilivEmailModal" tabindex="-1" aria-labelledby="ilivEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ilivEmailModalLabel">Send Fabric Request to ILIV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ilivEmailForm">
                    <div class="mb-3">
                        <label for="emailBodyText" class="form-label">Email Content:</label>
                        <textarea class="form-control" id="emailBodyText" rows="10"></textarea>
                    </div>
                    <div id="emailError" class="alert alert-danger d-none"></div>
                    <div id="emailSuccess" class="alert alert-success d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendILIVEmail" onclick="sendILIVEmail()">
                    <span id="sendButtonText">Send Email</span>
                    <span id="sendButtonSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block head %}
<style>
.search-highlight {
    background-color: yellow !important;
    font-weight: bold;
}

/* Make table more compact for better screen fit */
.table-sm td, .table-sm th {
    padding: 0.4rem 0.3rem;
}

/* Black lines between rows */
.table tbody tr {
    border-bottom: 1px solid black !important;
}

.table thead tr {
    border-bottom: 2px solid black !important;
}

.table td, .table th {
    border-top: none !important;
    border-bottom: none !important;
}

/* Remove all Bootstrap table borders */
.table-striped > tbody > tr:nth-of-type(odd) > * {
    --bs-table-bg-type: none !important;
    background-color: transparent !important;
}

/* Ensure fabrics are not truncated */
.badge {
    display: inline-block !important;
    white-space: nowrap !important;
}

/* Override any text truncation */
.text-truncate {
    overflow: visible !important;
    text-overflow: clip !important;
    white-space: normal !important;
}

/* Style for dispatched rows */
.dispatched-row {
    background-color: #f8f9fa !important;
}

/* Separator row style */
.table-separator td {
    border-bottom: 2px solid #6c757d !important;
    font-weight: 600;
}

.dropdown-menu-sm {
    font-size: 0.85rem;
}

.btn-group-sm > .btn {
    padding: 0.1rem 0.3rem;
}

/* Responsive adjustments */
@media (max-width: 1400px) {
    .table {
        font-size: 0.8rem !important;
    }
    
    .badge {
        font-size: 0.65rem !important;
    }
}

@media (max-width: 768px) {
    .table {
        font-size: 0.75rem !important;
    }
    
    .text-truncate {
        max-width: 100px !important;
    }
}
</style>
{% endblock %}



{% block scripts %}
<script>
// Real-time search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    const tableRows = document.querySelectorAll('tbody tr');
    
    // Remove highlight class
    function removeHighlights() {
        document.querySelectorAll('.search-highlight').forEach(el => {
            el.classList.remove('search-highlight');
            if (el.tagName === 'MARK') {
                const parent = el.parentNode;
                parent.replaceChild(document.createTextNode(el.textContent), el);
                parent.normalize();
            }
        });
    }
    
    // Highlight matching text
    function highlightText(element, searchTerm) {
        if (!searchTerm) return;
        
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
            textNodes.push(node);
        }
        
        textNodes.forEach(textNode => {
            const text = textNode.nodeValue;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            
            if (regex.test(text)) {
                const span = document.createElement('span');
                span.innerHTML = text.replace(regex, '<mark class="search-highlight">$1</mark>');
                textNode.parentNode.replaceChild(span, textNode);
            }
        });
    }
    
    // Search function
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        removeHighlights();
        
        if (!searchTerm) {
            tableRows.forEach(row => row.style.display = '');
            return;
        }
        
        tableRows.forEach(row => {
            let found = false;
            const cells = row.querySelectorAll('td');
            
            cells.forEach(cell => {
                const text = cell.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    found = true;
                    // Highlight matching text
                    highlightText(cell, searchTerm);
                }
            });
            
            row.style.display = found ? '' : 'none';
        });
    }
    
    // Attach event listener for real-time search
    if (searchInput) {
        searchInput.addEventListener('input', performSearch);
        // Perform search on page load if there's already a search term
        if (searchInput.value) {
            performSearch();
        }
    }
});

function updateStatus(requestId, newStatus) {
    fetch(`/admin/update_status/${requestId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge
            const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
            const statusCell = row.children[6].querySelector('.badge');
            
            statusCell.textContent = newStatus;
            statusCell.className = 'badge ' + getStatusBadgeClass(newStatus);
            
            // Update dispatch date if applicable
            if (data.date_dispatched) {
                const dispatchDateSpan = document.getElementById(`dispatch-date-${requestId}`);
                dispatchDateSpan.textContent = data.date_dispatched;
            }
            
            // Show success message
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Error updating status');
    });
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'Outstanding':
            return 'bg-warning text-dark';
        case 'In Progress':
            return 'bg-info';
        case 'Dispatched':
            return 'bg-success';
        default:
            return 'bg-secondary';
    }
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// ILIV Email functionality
let currentRequestId = null;
let ilivModal = null;

function openILIVModal(requestId) {
    console.log('openILIVModal called with requestId:', requestId);
    currentRequestId = requestId;
    
    try {
        // Get the fabric selections for this request
        const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
        if (!row) {
            console.error('Row not found for requestId:', requestId);
            return;
        }
        
        const fabricCell = row.querySelector('td:nth-child(6)'); // Fabrics column
        if (!fabricCell) {
            console.error('Fabric cell not found');
            return;
        }
        
        const fabricBadges = fabricCell.querySelectorAll('.badge');
        
        let fabricList = [];
        fabricBadges.forEach(badge => {
            const fabric = badge.textContent.trim();
            if (fabric && fabric !== '-') {
                fabricList.push(`- ${fabric}`);
            }
        });
        
        // Create email template
        const emailTemplate = `Hi Juris

Please send us the following cuttings:
${fabricList.join('\n')}

Please send the order confirmation to: ORDERS@SLENDERMORRIS.COM (NOT this email address)

Thanks
Matthew & Neville - Slender Morris`;
        
        // Set the email content
        const emailBodyText = document.getElementById('emailBodyText');
        if (emailBodyText) {
            emailBodyText.value = emailTemplate;
        } else {
            console.error('emailBodyText element not found');
            return;
        }
        
        // Clear any previous error/success messages
        const emailError = document.getElementById('emailError');
        const emailSuccess = document.getElementById('emailSuccess');
        if (emailError) emailError.classList.add('d-none');
        if (emailSuccess) emailSuccess.classList.add('d-none');
        
        // Show the modal
        const modalElement = document.getElementById('ilivEmailModal');
        if (!modalElement) {
            console.error('ILIV modal element not found');
            return;
        }
        
        if (!ilivModal) {
            console.log('Creating new modal instance');
            ilivModal = new bootstrap.Modal(modalElement);
        }
        console.log('Showing modal');
        ilivModal.show();
    } catch (error) {
        console.error('Error in openILIVModal:', error);
    }
}

// Make the function globally available
window.openILIVModal = openILIVModal;

function sendILIVEmail() {
    if (!currentRequestId) {
        console.error('No request ID set');
        return;
    }
    
    const emailBody = document.getElementById('emailBodyText').value.trim();
    const sendButton = document.getElementById('sendILIVEmail');
    const sendButtonText = document.getElementById('sendButtonText');
    const sendButtonSpinner = document.getElementById('sendButtonSpinner');
    const errorDiv = document.getElementById('emailError');
    const successDiv = document.getElementById('emailSuccess');
    
    if (!emailBody) {
        errorDiv.textContent = 'Please enter email content.';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    // Show loading state
    sendButton.disabled = true;
    sendButtonText.classList.add('d-none');
    sendButtonSpinner.classList.remove('d-none');
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    // Send the email
    fetch(`/admin/email_iliv/${currentRequestId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email_body: emailBody
        })
    })
    .then(response => response.json())
    .then(data => {
        // Reset button state
        sendButton.disabled = false;
        sendButtonText.classList.remove('d-none');
        sendButtonSpinner.classList.add('d-none');
        
        if (data.success) {
            successDiv.textContent = data.message;
            successDiv.classList.remove('d-none');
            
            // Close modal after 2 seconds and reset for next use
            setTimeout(() => {
                ilivModal.hide();
                // Reset modal state for next use
                currentRequestId = null;
                document.getElementById('emailBodyText').value = '';
                errorDiv.classList.add('d-none');
                successDiv.classList.add('d-none');
            }, 2000);
            
            // Show success alert
            showAlert('success', data.message);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Reset button state
        sendButton.disabled = false;
        sendButtonText.classList.remove('d-none');
        sendButtonSpinner.classList.add('d-none');
        
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
    });
}

// Initialize everything after DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize ILIV modal
    const ilivModalElement = document.getElementById('ilivEmailModal');
    if (ilivModalElement) {
        ilivModal = new bootstrap.Modal(ilivModalElement);
        
        // Reset modal when hidden
        ilivModalElement.addEventListener('hidden.bs.modal', function () {
            console.log('Modal hidden, resetting state');
            currentRequestId = null;
            document.getElementById('emailBodyText').value = '';
            document.getElementById('emailError').classList.add('d-none');
            document.getElementById('emailSuccess').classList.add('d-none');
            
            // Reset send button state
            const sendButton = document.getElementById('sendILIVEmail');
            const sendButtonText = document.getElementById('sendButtonText');
            const sendButtonSpinner = document.getElementById('sendButtonSpinner');
            if (sendButton) sendButton.disabled = false;
            if (sendButtonText) sendButtonText.classList.remove('d-none');
            if (sendButtonSpinner) sendButtonSpinner.classList.add('d-none');
        });
    }
});
</script>
{% endblock %}
